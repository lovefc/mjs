!function(factory){if("object"==typeof exports)module.exports=factory();else if("function"==typeof define&&define.amd)define(factory);else{let glob;try{glob=window}catch(e){glob=self}glob.mjs=factory()}}((function(){let mjs=function(){let that=this;if(!new.target)return new mjs;this.audio="",this.playStatus=0,this.currentTime=0,this.arrMusic=new Array,this.nowPlayNum=0,this.operation,this.arrMusicNum=0,this.lycArray=new Array,this.newLyc="",this.volume=1,this.currentnum=0,this.order=0,this.task,this.lycCallback=function(){},this.switchCallback=function(){},this.timeCallback=function(){},this.initCallback=function(){},this._lycCallback=async function(){"function"==typeof that.lycCallback&&that.lycCallback(that.newLyc)},this._timeCallback=async function(){if("function"==typeof that.timeCallback){let times=new Array;times.nowtime=that.setTimes(Math.round(that.audio.currentTime)),times.alltime=that.setTimes(Math.round(that.audio.duration));let playProgress=Math.round(that.audio.currentTime/that.audio.duration*100);playProgress=isNaN(playProgress)?0:playProgress,times.progress=playProgress,that.timeCallback(times)}},this.timeupdate=function(){that.lycArray.length>0&&(that.currentnum==that.lycArray.length-1&&that.audio.currentTime.toFixed(3)>=parseFloat(that.lycArray[that.currentnum].t)&&(that.newLyc=that.lycArray[that.currentnum].c),parseInt(that.lycArray[that.currentnum].t)<=parseInt(that.audio.currentTime+.05)&&parseInt(that.audio.currentTime+.05)<=parseInt(that.lycArray[that.currentnum+1].t)&&(that.audio.currentTime>0&&(that.newLyc=that.lycArray[that.currentnum].c),that.currentnum++))},this.init=function(data,order,volume,cross){if(!data)return!1;this.audio=document.createElement("audio"),!0===cross&&(this.audio.crossOrigin="anonymous",this.audio.controls=!1),this.audio.src="",volume&&this.playVolume(parseFloat(volume)),order&&this.orderMusic(parseInt(order)),document.body.appendChild(this.audio),this.jsonToArray(data),"function"==typeof this.initCallback&&this.initCallback(this.arrMusic[this.nowPlayNum]),this.audio.addEventListener("durationchange",(function(){window.clearInterval(that.task)}),!1),this.audio.addEventListener("error",(function(){that.task=window.setInterval((function(){that.audio.duration||1==that.playStatus&&("add"===that.operation&&that.nextMusic(),"minus"===that.operation&&that.prevMusic())}),1e3)}),!1),this.audio.addEventListener("ended",(function(){that.operation,1==that.playStatus&&(2!=that.order?that.nextMusic():that.autoPlay())}),!1),this.audio.addEventListener("canplay",(function(){that.audio.ontimeupdate=that.timeupdate}),!1),this.audio.addEventListener("seeked",(function(){that._timeCallback()}),!1);let music_currentnum=setInterval((function(){for(1==that.playStatus&&(that._timeCallback(),that._lycCallback()),i=0;i<that.lycArray.length;i++)parseInt(that.lycArray[i].t)<=parseInt(that.audio.currentTime+.1)&&parseInt(that.lycArray[i+1].t)>=parseInt(that.audio.currentTime+.1)&&(that.currentnum=i)}),500)},this.orderMusic=function(num){this.order=+num},this.playOrder=function(){let num,nowPlayNum=0;switch(this.order){case 1:nowPlayNum=parseInt(Math.random()*(this.arrMusicNum-1+1),10),this.nowPlayNum=nowPlayNum;break;case 2:nowPlayNum=this.nowPlayNum}return nowPlayNum},this.getAudio=function(){return this.audio},this.jsonToArray=function(json){if(this.arrMusic=new Array,null==json&&""==json.toString())return void console.log("json error");let index=0;for(let item in json)this.arrMusic[index]=json[item],index++;this.arrMusicNum=this.arrMusic.length,this.playOrder(),this.attrMusic(this.arrMusic[this.nowPlayNum])},this.attrMusic=function(arr,callback){arr&&arr.hasOwnProperty("url")&&(this.audio.src=arr.url,this.audio.load(),this.currentTime=this.audio.currentTime,this.createLrc(arr.lyc),this.currentnum=0,"function"==typeof this.switchCallback&&this.switchCallback(arr))},this.createLrc=function(lycText){if(this.lycArray=new Array,!lycText)return;let lycs=new Array,medises=lycText.split("\n");for(let i=0;i<medises.length;i++){let item=medises[i],t=item.substring(item.indexOf("[")+1,item.indexOf("]"));this.lycArray.push({t:(60*t.split(":")[0]+parseFloat(t.split(":")[1])).toFixed(3),c:item.substring(item.indexOf("]")+1,item.length)})}},this.autoPlay=function(callback){this.playStatus=1,this.audio.play(),"function"==typeof callback&&callback()},this.stopPlay=function(callback){this.playStatus=0,this.audio.pause(),"function"==typeof callback&&callback()},this.prevMusic=function(callback){this.operation="minus";let order=this.playOrder();0===order?this.nowPlayNum--:this.nowPlayNum=order,this.nowPlayNum<0&&(this.nowPlayNum=this.arrMusicNum-1),this.attrMusic(this.arrMusic[this.nowPlayNum]),"function"==typeof callback&&callback(this.arrMusic[this.nowPlayNum]),1==this.playStatus&&this.audio.play()},this.nextMusic=function(callback){this.operation="add";let order=this.playOrder();0===order?this.nowPlayNum++:this.nowPlayNum=order,this.nowPlayNum>this.arrMusicNum&&(this.nowPlayNum=0),this.attrMusic(this.arrMusic[this.nowPlayNum]),"function"==typeof callback&&callback(this.arrMusic[this.nowPlayNum]),1==this.playStatus&&this.audio.play()},this.playProgress=function(val){that.audio.duration&&val&&(that.audio.currentTime=Math.round(that.audio.duration*(val/100)),that._timeCallback())},this.playVolume=function(volume,callback){volume=volume>1?1:volume,this.audio.volume=volume,"function"==typeof callback&&callback(volume)},this.playRate=function(val,callback){val/=100,this.audio.playbackRate=val,"function"==typeof callback&&callback(val)},this.setTimes=function(value){let theTime=parseInt(value),theTime1=0,theTime2=0;theTime>60&&(theTime1=parseInt(theTime/60),theTime=parseInt(theTime%60),theTime1>60&&(theTime2=parseInt(theTime1/60),theTime1=parseInt(theTime1%60)));let theTime_y=parseInt(theTime);theTime_y<10&&(theTime_y="0"+theTime_y);let results=""+theTime_y;if(theTime1>0||0==theTime1){let theTime1_y=parseInt(theTime1);theTime1_y<10&&(theTime1_y="0"+theTime1_y),results=theTime1_y+":"+results}if(theTime2>0||0==theTime2){let theTime2_y=parseInt(theTime2);theTime2_y<10&&(theTime2_y="0"+theTime2_y),results=theTime2_y+":"+results}return results}};return mjs}));